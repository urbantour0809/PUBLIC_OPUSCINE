<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï - OpusCine</title>
    <link rel="icon" type="image/x-icon" href="<c:url value='/resources/src/images/favicon.ico'/>">
    <link rel="stylesheet" href="<c:url value='/resources/css/base.css'/>">
    <link rel="stylesheet" href="<c:url value='/resources/css/layout.css'/>">
    <link rel="stylesheet" href="<c:url value='/resources/css/components.css'/>">
    <link rel="stylesheet" href="<c:url value='/resources/css/profile.css'/>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <div class="logo">OPUSCINE</div>
                <ul class="nav-menu">
                    <li><a href="<c:url value='/'/>" class="nav-link">Ìôà</a></li>
                    <li><a href="<c:url value='/ai-recommendations'/>" class="nav-link">AI Ï∂îÏ≤ú</a></li>
                    <li><a href="<c:url value='/movies'/>" class="nav-link">ÏòÅÌôî</a></li>
                    <li><a href="<c:url value='/trending'/>" class="nav-link">Ìä∏Î†åÎî©</a></li>
                    <li><a href="<c:url value='/user/my-list'/>" class="nav-link">ÎÇ¥Í∞Ä Ï∞úÌïú ÏΩòÌÖêÏ∏†</a></li>
                </ul>
            </div>
            <div class="nav-right">
                <div class="search-icon">üîç</div>
                <div class="notifications">üîî</div>

                <sec:authorize access="isAuthenticated()">
                    <div class="user-menu">
                        <div class="user-dropdown">
                        <c:choose>
                            <c:when test="${not empty profile.provider}">
                                <img src="${profile.imgNm}"alt="Profile" class="user-profile-img">
                            </c:when>
                            <c:otherwise>
                            <img src="<c:url value='/resources/profiles/${profile.imgNm}.jpg'/>"
                                                             alt="Profile" class="user-profile-img">
                            </c:otherwise>
                        </c:choose>

                            <div class="user-dropdown-content" id="userDropdown">
                                <a href="<c:url value='/user/profile'/>" class="active">ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</a>
                                <a href="<c:url value='/logout'/>">Î°úÍ∑∏ÏïÑÏõÉ</a>
                            </div>
                        </div>
                    </div>
                </sec:authorize>
                <sec:authorize access="isAnonymous()">
                    <div class="auth-links">
                        <a href="<c:url value='/login'/>" class="login-link">Î°úÍ∑∏Ïù∏</a>
                        <a href="<c:url value='/signup'/>" class="signup-link">ÌöåÏõêÍ∞ÄÏûÖ</a>
                    </div>
                </sec:authorize>
            </div>
        </div>
    </nav>

    <!-- ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="profile-container">
        <!-- Ìó§Îçî -->
        <div class="profile-header">
            <h1>ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</h1>
            <p>Í≥ÑÏ†ï Ï†ïÎ≥¥Î•º Í¥ÄÎ¶¨ÌïòÍ≥† Í∞úÏù∏ ÏÑ§Ï†ïÏùÑ Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
        </div>

        <!-- Î©îÏãúÏßÄ ÌëúÏãú ÏòÅÏó≠ -->
        <div id="message" class="message"></div>

        <!-- ÌîÑÎ°úÌïÑ Ïª®ÌÖêÏ∏† -->
        <div class="profile-content">
            <!-- ÌîÑÎ°úÌïÑ ÏÇ¨Ïù¥ÎìúÎ∞î -->
            <div class="profile-sidebar">
                <div class="current-profile">
                <c:choose>
                    <c:when test="${not empty profile.provider}">
                    <img id="current-profile-img" src="${profile.imgNm}"
                                             alt="ÌòÑÏû¨ ÌîÑÎ°úÌïÑ" class="current-profile-image">
                    </c:when>
                    <c:otherwise>
                    <img id="current-profile-img" src="<c:url value='/resources/profiles/${profile.imgNm}.jpg'/>"
                                             alt="ÌòÑÏû¨ ÌîÑÎ°úÌïÑ" class="current-profile-image">
                    </c:otherwise>
                </c:choose>
                    <div id="current-username" class="current-username">${profile.nicknmame}</div>
                    <div id="current-email" class="current-email">${profile.email}</div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <span>Í∞ÄÏûÖÏùº</span>
                        <span class="stat-value">${profile.reg_date}</span>
                    </div>
                    <div class="stat-item">
                        <span>Ï∞úÌïú ÏΩòÌÖêÏ∏†</span>
                        <span class="stat-value">${profile.interest_count}</span>
                    </div>
                    <div class="stat-item">
                        <span>ÌèâÍ∞ÄÌïú ÏòÅÌôî</span>
                        <span class="stat-value">${profile.evaluate_count}</span>
                    </div>
                    <div class="stat-item">
                        <span>ÏãúÏ≤≠ ÏãúÍ∞Ñ</span>
                        <span class="stat-value">${profile.streaming_count}</span>
                    </div>
                </div>
            </div>

            <!-- ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï Ìèº -->
            <div class="profile-form-container">
                <form id="profileForm" class="profile-form" >
                <input type="hidden" id="provider" name="provider" value="${profile.provider}">
                    <c:choose>
                        <c:when test="${empty profile.provider}">
                        <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω ÏÑπÏÖò -->
                            <div class="form-section">
                                <h3 class="section-title">
                                    <span class="section-icon">üì∑</span>
                                    ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ
                                </h3>
                                <div class="profile-image-selector">
                                    <div class="profile-option" data-profile="profile1" selected>
                                        <img src="<c:url value='/resources/profiles/profile1.jpg'/>" alt="ÌîÑÎ°úÌïÑ 1">
                                    </div>
                                    <div class="profile-option" data-profile="profile2">
                                        <img src="<c:url value='/resources/profiles/profile2.jpg'/>" alt="ÌîÑÎ°úÌïÑ 2">
                                    </div>
                                    <div class="profile-option" data-profile="profile3">
                                        <img src="<c:url value='/resources/profiles/profile3.jpg'/>" alt="ÌîÑÎ°úÌïÑ 3">
                                    </div>
                                    <div class="profile-option" data-profile="profile4">
                                        <img src="<c:url value='/resources/profiles/profile4.jpg'/>" alt="ÌîÑÎ°úÌïÑ 4">
                                    </div>
                                    <div class="profile-option" data-profile="profile5">
                                        <img src="<c:url value='/resources/profiles/profile5.jpg'/>" alt="ÌîÑÎ°úÌïÑ 5">
                                    </div>
                                    <div class="profile-option" data-profile="profile6">
                                        <img src="<c:url value='/resources/profiles/profile6.jpg'/>" alt="ÌîÑÎ°úÌïÑ 6">
                                    </div>
                                </div>
                                <input type="hidden" id="selectedProfile" name="imgNm" value="${profile.imgNm}">
                            </div>
                        </c:when>
                    </c:choose>
                    <input type="hidden" id="selectedProfile" name="imgNm" value="${profile.imgNm}">
                    <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <span class="section-icon">üë§</span>
                            Í∏∞Î≥∏ Ï†ïÎ≥¥
                        </h3>
                        
                        <div class="form-group">
                            <label for="nickname" class="form-label">ÎãâÎÑ§ÏûÑ</label>
                            <input type="text" id="nicknmame" name="nicknmame" class="form-input"
                                   placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="20">
                        </div>
                        
                        <div class="form-group">
                            <label for="email" class="form-label">Ïù¥Î©îÏùº</label>
                            <input type="email" id="email" name="email" class="form-input" 
                                   placeholder="Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                        </div>
                    </div>

                    <!-- ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω ÏÑπÏÖò -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <span class="section-icon">üîí</span>
                            ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                        </h3>

                        <div class="form-group">
                            <label for="newPassword" class="form-label">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                            <input type="password" id="newPassword" name="newPassword"
                                   class="form-input" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" minlength="8">
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword" class="form-label">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                            <input type="password" id="confirmPassword" name="confirmPassword"
                                   class="form-input" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Îã§Ïãú ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                        </div>
                    </div>

                    <input type="hidden" id="user_id" name="user_id" value="${profile.user_id}"/>

                    <!-- Ï†ÄÏû• Î≤ÑÌäº -->
                    <div class="btn-group">
                        <button type="button" class="profile-btn btn-secondary" onclick="resetForm()">
                            <span>Ï∑®ÏÜå</span>
                        </button>
                        <button type="submit" class="profile-btn btn-primary">
                            <span>Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ Ï†ÄÏû•</span>
                        </button>
                    </div>
                </form>

                <!-- ÏúÑÌóò Íµ¨Ïó≠ -->
                <div class="danger-zone">
                    <h3 class="section-title">
                        <span class="section-icon">‚ö†Ô∏è</span>
                        Ï£ºÏùò
                    </h3>
                    <p class="danger-warning">
                        ÌöåÏõê ÌÉàÌá¥ Ïãú Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÎ©∞, Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§. 
                        Ï∞úÌïú ÏΩòÌÖêÏ∏†, ÌèâÍ∞Ä Í∏∞Î°ù, ÏãúÏ≤≠ Í∏∞Î°ù Îì±Ïù¥ Î™®Îëê ÏÇ¨ÎùºÏßëÎãàÎã§.
                    </p>
                    <button type="button" class="profile-btn btn-danger" onclick="showDeleteAccountModal()">
                        <span>üóëÔ∏è</span>
                        <span>ÌöåÏõê ÌÉàÌá¥</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÌöåÏõêÌÉàÌá¥ ÌôïÏù∏ Î™®Îã¨ -->
    <div id="deleteAccountModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ÌöåÏõê ÌÉàÌá¥ ÌôïÏù∏</h3>
                <button class="modal-close" onclick="hideDeleteAccountModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6;">
                    Ï†ïÎßêÎ°ú ÌöåÏõê ÌÉàÌá¥Î•º ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br>
                    Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏúºÎ©∞, Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎê©ÎãàÎã§.
                </p>
                <div class="form-group">
                    <label for="deleteConfirmPassword" class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                    <input type="password" id="deleteConfirmPassword" class="form-input" 
                           placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏó¨ ÌôïÏù∏ÌïòÏÑ∏Ïöî">
                </div>
                <div class="btn-group" style="margin-top: 25px;">
                    <button type="button" class="profile-btn btn-secondary" onclick="hideDeleteAccountModal()">
                        Ï∑®ÏÜå
                    </button>
                    <button type="button" class="profile-btn btn-danger" onclick="deleteAccount()">
                        ÌöåÏõê ÌÉàÌá¥
                    </button>
                </div>
            </div>
        </div>
    </div>



    
    <script>

        const user_id=document.getElementById('user_id').value;
        // ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù Í∏∞Îä•
        document.addEventListener('DOMContentLoaded', function() {
            const provider = document.getElementById('provider');
            if(!provider){
            initProfilePage();
            }else{
            document.getElementById('profileForm').addEventListener('submit', handleFormSubmit);}
        });

        function initProfilePage() {
            // ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
            const profileOptions = document.querySelectorAll('.profile-option');
            const selectedProfileInput = document.getElementById('selectedProfile');
            const selectedProfileInput_value = selectedProfileInput.value;
            console.log(selectedProfileInput_value);
            const profileOption = document.querySelector('[data-profile="'+selectedProfileInput_value+'"]');
            profileOption.classList.add('selected');
            profileOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Î™®Îì† ÏÑ†ÌÉù Ìï¥Ï†ú
                    profileOptions.forEach(opt => opt.classList.remove('selected'));

                    // ÏÑ†ÌÉùÎêú ÌîÑÎ°úÌïÑ ÌëúÏãú
                    this.classList.add('selected');

                    // Í∞í Ï†ÄÏû•
                    const profileValue = this.dataset.profile;
                    selectedProfileInput.value = profileValue;

                    // ÏÇ¨Ïù¥ÎìúÎ∞î Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                    const currentProfileImg = document.getElementById('current-profile-img');
                    currentProfileImg.src = this.querySelector('img').src;
                });
            });

            // Ìèº Ï†úÏ∂ú Ïù¥Î≤§Ìä∏
            document.getElementById('profileForm').addEventListener('submit', handleFormSubmit);
        }



        // Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨
        async function handleFormSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            try {
                // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
                submitBtn.classList.add('btn-loading');
                submitBtn.innerHTML = '<span>Ï†ÄÏû• Ï§ë...</span>';

                // ÌïÑÎìú Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const nickname = document.getElementById('nicknmame').value;
                const email = document.getElementById('email').value;
                let selectedProfileElem = document.getElementById('selectedProfile');
                let selectedProfile =  selectedProfileElem.value;

                // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
                if (newPassword !== confirmPassword) {
                    showMessage('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.', 'error');
                    return; // ÏöîÏ≤≠ Ï§ëÎã®
                }

                // ÌïÑÏàò Í∞í ÌôïÏù∏
                if (!nickname || !email || !confirmPassword) {
                    showMessage('ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return; // ÏöîÏ≤≠ Ï§ëÎã®
                }

                const formData = {
                    user_id: user_id,
                    email: email,
                    nicknmame: nickname,
                    imgNm: selectedProfile,
                    pwd: confirmPassword
                };

                const res = await fetch('/OpusCine/user/updateProfile', {
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    method: "PATCH",
                    body: JSON.stringify(formData)
                });

                if (res.ok) {
                    showMessage('ÌîÑÎ°úÌïÑÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    showMessage('ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }

            } catch (error) {
                console.error('ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
                showMessage(error.message || 'ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                // Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
                submitBtn.classList.remove('btn-loading');
                submitBtn.innerHTML = originalText;
            }
        }


        // Ìèº Î¶¨ÏÖã
        function resetForm() {
            if (confirm('Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                document.getElementById('profileForm').reset();
                loadUserProfile();
            }
        }

        // ÌöåÏõêÌÉàÌá¥ Î™®Îã¨ ÌëúÏãú
        function showDeleteAccountModal() {
            document.getElementById('deleteAccountModal').style.display = 'flex';
        }

        // ÌöåÏõêÌÉàÌá¥ Î™®Îã¨ Ïà®ÍπÄ
        function hideDeleteAccountModal() {
            document.getElementById('deleteAccountModal').style.display = 'none';
            document.getElementById('deleteConfirmPassword').value = '';
        }

        // ÌöåÏõêÌÉàÌá¥ Ï≤òÎ¶¨
        async function deleteAccount() {
            const password = document.getElementById('deleteConfirmPassword').value;

            if (!password) {
                showMessage('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            if (!confirm('Ï†ïÎßêÎ°ú ÌöåÏõêÌÉàÌá¥Î•º ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                return;
            }

            try {

                 const response = await fetch('/OpusCine/user/delete', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({'pwd': password,'user_id':user_id })
                 });

                 if(response.status ==204){
                alert('ÌöåÏõêÌÉàÌá¥Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
                window.location.href = '/OpusCine';
                }

            } catch (error) {
                console.error('ÌöåÏõêÌÉàÌá¥ Ïã§Ìå®:', error);
                showMessage('ÌöåÏõêÌÉàÌá¥Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
            }
        }

        // Î©îÏãúÏßÄ ÌëúÏãú
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';

            // 3Ï¥à ÌõÑ ÏûêÎèô Ïà®ÍπÄ
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html> 